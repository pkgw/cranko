steps:
- checkout: self
  fetchDepth: 1

- template: azure-install-rust.yml

- bash: rustup target add $OTHER_TARGET
  displayName: "Install cross-compile target"

- bash: sudo apt update -y && sudo apt install gcc-multilib -y
  displayName: "Install gcc-multilib (linux)"
  condition: and(succeeded(), eq(variables['Agent.OS'], 'Linux'))

# Bootstrap with the unmodified checkout at 0.0.0 versions.

- bash: cargo build --all
  displayName: "cargo build (bootstrap)"

- bash: cargo run -- apply
  displayName: "cranko apply (using bootstrapped build)"

- bash: git show HEAD
  displayName: "git show HEAD"  # show what cranko apply did

# Now that we've applied versions, mainline test workflow

- bash: cargo build --all --release
  displayName: "cargo build (release)"

- bash: cargo test --all --release
  displayName: "cargo test (release)"

- bash: find . -name cranko-target.txt -execdir cat '{}' ';' -quit
  displayName: "Get target triple"
